// Importa o CSS para o Webpack processar
import '../css/styles.css';

/**
 * Aplica√ß√£o de Finan√ßas Pessoais - Vers√£o Standalone
 * Funciona 100% no navegador usando apenas localStorage
 * N√£o precisa de json-server ou API externa
 */
class FinanceApp {
  constructor() {
    this.transactions = [];
    this.isInitialized = false;
    this.storageKey = 'financeApp_transactions';
  }

  /**
   * Inicializa a aplica√ß√£o
   */
  async init() {
    try {
      console.log('üöÄ Iniciando aplica√ß√£o de Finan√ßas Pessoais...');

      // Verifica se o DOM est√° carregado
      if (document.readyState === 'loading') {
        await this.waitForDOMReady();
      }

      // Carrega dados do localStorage
      this.loadTransactions();

      // Configura eventos
      this.setupEventListeners();

      // Configura funcionalidades extras
      this.setupExtraFeatures();

      this.isInitialized = true;
      console.log('‚úÖ Aplica√ß√£o inicializada com sucesso!');

    } catch (error) {
      console.error('‚ùå Erro ao inicializar aplica√ß√£o:', error);
      this.showInitializationError(error);
    }
  }

  /**
   * Carrega transa√ß√µes do localStorage
   */
  loadTransactions() {
    try {
      const savedTransactions = localStorage.getItem(this.storageKey);

      if (savedTransactions) {
        this.transactions = JSON.parse(savedTransactions);
      } else {
        // Dados iniciais se n√£o houver nada salvo
        this.transactions = [
          { id: 1, name: "Sal√°rio", value: 5000 },
          { id: 2, name: "Mercado", value: -350 },
          { id: 3, name: "Freelance", value: 1200 }
        ];
        this.saveTransactions();
      }

      this.renderTransactions();
      this.updateBalance();
      console.log(`üìä ${this.transactions.length} transa√ß√µes carregadas do localStorage`);

    } catch (error) {
      console.error('‚ùå Erro ao carregar transa√ß√µes:', error);
      this.transactions = [];
      this.renderTransactions();
      this.updateBalance();
    }
  }

  /**
   * Salva transa√ß√µes no localStorage
   */
  saveTransactions() {
    try {
      localStorage.setItem(this.storageKey, JSON.stringify(this.transactions));
      console.log('üíæ Transa√ß√µes salvas no localStorage');
    } catch (error) {
      console.error('‚ùå Erro ao salvar transa√ß√µes:', error);
      this.showError('Erro ao salvar dados. Verifique se o localStorage est√° dispon√≠vel.');
    }
  }

  /**
   * Configura os event listeners
   */
  setupEventListeners() {
    const form = document.getElementById('transaction-form');
    const cancelBtn = document.getElementById('cancel-btn');

    if (form) {
      form.addEventListener('submit', (e) => this.handleSubmit(e));
    }

    if (cancelBtn) {
      cancelBtn.addEventListener('click', () => this.cancelEdit());
    }
  }

  /**
   * Manipula o envio do formul√°rio
   */
  handleSubmit(event) {
    event.preventDefault();

    const name = document.getElementById('name').value.trim();
    const value = parseFloat(document.getElementById('value').value);

    if (!name || isNaN(value)) {
      this.showAlert('Por favor, preencha todos os campos corretamente.');
      return;
    }

    const transactionData = { name, value };
    const editingId = event.target.dataset.editingId;

    if (editingId) {
      this.updateTransaction(parseInt(editingId), transactionData);
    } else {
      this.createTransaction(transactionData);
    }
  }

  /**
   * Cria uma nova transa√ß√£o
   */
  createTransaction(transactionData) {
    try {
      const newTransaction = {
        id: Date.now(), // ID √∫nico baseado no timestamp
        name: transactionData.name,
        value: transactionData.value
      };

      this.transactions.push(newTransaction);
      this.saveTransactions();
      this.renderTransactions();
      this.updateBalance();
      this.resetForm();
      this.showSuccess('Transa√ß√£o criada com sucesso!');

    } catch (error) {
      console.error('‚ùå Erro ao criar transa√ß√£o:', error);
      this.showAlert('Erro ao criar transa√ß√£o. Tente novamente.');
    }
  }

  /**
   * Atualiza uma transa√ß√£o
   */
  updateTransaction(id, transactionData) {
    try {
      const index = this.transactions.findIndex(t => t.id === id);

      if (index === -1) {
        this.showAlert('Transa√ß√£o n√£o encontrada.');
        return;
      }

      this.transactions[index] = {
        ...this.transactions[index],
        name: transactionData.name,
        value: transactionData.value
      };

      this.saveTransactions();
      this.renderTransactions();
      this.updateBalance();
      this.resetForm();
      this.showSuccess('Transa√ß√£o atualizada com sucesso!');

    } catch (error) {
      console.error('‚ùå Erro ao atualizar transa√ß√£o:', error);
      this.showAlert('Erro ao atualizar transa√ß√£o. Tente novamente.');
    }
  }

  /**
   * Exclui uma transa√ß√£o
   */
  deleteTransaction(id) {
    if (!confirm('Tem certeza que deseja excluir esta transa√ß√£o?')) return;

    try {
      const initialLength = this.transactions.length;
      this.transactions = this.transactions.filter(t => t.id !== parseInt(id));

      if (this.transactions.length === initialLength) {
        this.showAlert('Transa√ß√£o n√£o encontrada.');
        return;
      }

      this.saveTransactions();
      this.renderTransactions();
      this.updateBalance();
      this.showSuccess('Transa√ß√£o exclu√≠da com sucesso!');

    } catch (error) {
      console.error('‚ùå Erro ao excluir transa√ß√£o:', error);
      this.showAlert('Erro ao excluir transa√ß√£o. Tente novamente.');
    }
  }

  /**
   * Inicia a edi√ß√£o de uma transa√ß√£o
   */
  editTransaction(id) {
    const transaction = this.transactions.find(t => t.id === parseInt(id));
    if (!transaction) {
      this.showAlert('Transa√ß√£o n√£o encontrada.');
      return;
    }

    document.getElementById('name').value = transaction.name;
    document.getElementById('value').value = transaction.value;

    const form = document.getElementById('transaction-form');
    const submitBtn = document.getElementById('submit-btn');
    const cancelBtn = document.getElementById('cancel-btn');

    form.dataset.editingId = id;
    submitBtn.textContent = 'Atualizar Transa√ß√£o';
    cancelBtn.style.display = 'inline-block';
  }

  /**
   * Cancela a edi√ß√£o
   */
  cancelEdit() {
    this.resetForm();
  }

  /**
   * Reseta o formul√°rio
   */
  resetForm() {
    const form = document.getElementById('transaction-form');
    const submitBtn = document.getElementById('submit-btn');
    const cancelBtn = document.getElementById('cancel-btn');

    if (form) form.reset();
    if (form) form.removeAttribute('data-editing-id');
    if (submitBtn) submitBtn.textContent = 'Adicionar Transa√ß√£o';
    if (cancelBtn) cancelBtn.style.display = 'none';
  }

  /**
   * Renderiza as transa√ß√µes na tela
   */
  renderTransactions() {
    const transactionsList = document.getElementById('transactions-list');
    if (!transactionsList) return;

    if (this.transactions.length === 0) {
      transactionsList.innerHTML = '<p>Nenhuma transa√ß√£o encontrada. Adicione uma nova transa√ß√£o!</p>';
      return;
    }

    transactionsList.innerHTML = this.transactions.map(transaction => `
      <div class="transaction-item ${transaction.value >= 0 ? 'income' : 'expense'}">
        <div class="transaction-info">
          <span class="transaction-name">${transaction.name}</span>
          <span class="transaction-value">R$ ${transaction.value.toFixed(2)}</span>
        </div>
        <div class="transaction-actions">
          <button onclick="app.editTransaction(${transaction.id})" class="edit-btn">‚úèÔ∏è Editar</button>
          <button onclick="app.deleteTransaction(${transaction.id})" class="delete-btn">üóëÔ∏è Excluir</button>
        </div>
      </div>
    `).join('');
  }

  /**
   * Atualiza o saldo total
   */
  updateBalance() {
    const balance = this.transactions.reduce((sum, transaction) => sum + transaction.value, 0);
    const balanceElement = document.getElementById('balance');

    if (balanceElement) {
      balanceElement.textContent = balance.toFixed(2);
      balanceElement.className = balance >= 0 ? 'positive' : 'negative';
    }
  }

  /**
   * Limpa todos os dados
   */
  clearAllData() {
    if (!confirm('‚ö†Ô∏è Isso ir√° apagar TODAS as transa√ß√µes. Tem certeza?')) return;

    this.transactions = [];
    this.saveTransactions();
    this.renderTransactions();
    this.updateBalance();
    this.showSuccess('Todos os dados foram apagados!');
  }

  /**
   * Exporta transa√ß√µes para JSON
   */
  exportTransactions() {
    const dataStr = JSON.stringify(this.transactions, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);

    const link = document.createElement('a');
    link.href = url;
    link.download = `transacoes_${new Date().toISOString().split('T')[0]}.json`;
    link.click();

    URL.revokeObjectURL(url);
    this.showSuccess('Dados exportados com sucesso!');
  }

  /**
   * Importa transa√ß√µes de arquivo JSON
   */
  importTransactions(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const importedData = JSON.parse(e.target.result);
        if (Array.isArray(importedData)) {
          this.transactions = importedData;
          this.saveTransactions();
          this.renderTransactions();
          this.updateBalance();
          this.showSuccess('Dados importados com sucesso!');
        } else {
          this.showAlert('Formato de arquivo inv√°lido.');
        }
      } catch (error) {
        this.showAlert('Erro ao importar arquivo. Verifique o formato.');
      }
    };
    reader.readAsText(file);
  }

  /**
   * Mostra mensagem de sucesso
   */
  showSuccess(message) {
    console.log('‚úÖ ' + message);
    alert('‚úÖ ' + message);
  }

  /**
   * Mostra mensagem de alerta
   */
  showAlert(message) {
    console.warn('‚ö†Ô∏è ' + message);
    alert('‚ö†Ô∏è ' + message);
  }

  /**
   * Mostra mensagem de erro
   */
  showError(message) {
    console.error('‚ùå ' + message);
    alert('‚ùå ' + message);
  }

  /**
   * Aguarda o DOM estar completamente carregado
   */
  waitForDOMReady() {
    return new Promise((resolve) => {
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        resolve();
      } else {
        document.addEventListener('DOMContentLoaded', resolve);
      }
    });
  }

  /**
   * Configura funcionalidades extras da aplica√ß√£o
   */
  setupExtraFeatures() {
    // Adiciona atalhos de teclado
    this.setupKeyboardShortcuts();

    // Adiciona informa√ß√µes de debug no console
    this.setupDebugInfo();

    // Configura tratamento de erros globais
    this.setupGlobalErrorHandling();
  }

  /**
   * Configura atalhos de teclado
   */
  setupKeyboardShortcuts() {
    document.addEventListener('keydown', (event) => {
      // Ctrl/Cmd + N = Nova transa√ß√£o (foca no campo nome)
      if ((event.ctrlKey || event.metaKey) && event.key === 'n') {
        event.preventDefault();
        const nameInput = document.getElementById('name');
        if (nameInput) {
          nameInput.focus();
        }
      }

      // Escape = Cancelar edi√ß√£o
      if (event.key === 'Escape') {
        const form = document.getElementById('transaction-form');
        if (form && form.dataset.editingId) {
          this.cancelEdit();
        }
      }
    });
  }

  /**
   * Configura informa√ß√µes de debug
   */
  setupDebugInfo() {
    // Adiciona m√©todos de debug ao objeto window
    window.financeApp = {
      getTransactions: () => this.transactions,
      clearAll: () => this.clearAllData(),
      exportData: () => this.exportTransactions(),
      refresh: () => this.loadTransactions(),
      version: '3.0.0',
      mode: 'Standalone - localStorage only'
    };

    console.log('üîß Ferramentas de debug dispon√≠veis em window.financeApp');
  }

  /**
   * Configura tratamento de erros globais
   */
  setupGlobalErrorHandling() {
    window.addEventListener('error', (event) => {
      console.error('‚ùå Erro global capturado:', event.error);
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('‚ùå Promise rejeitada n√£o tratada:', event.reason);
    });
  }

  /**
   * Mostra erro de inicializa√ß√£o
   */
  showInitializationError(error) {
    const container = document.querySelector('.container');
    if (container) {
      container.innerHTML = `
        <div style="text-align: center; padding: 50px; background: white; border-radius: 10px; margin: 20px;">
          <h2 style="color: #e53e3e; margin-bottom: 20px;">‚ùå Erro de Inicializa√ß√£o</h2>
          <p style="margin-bottom: 20px;">N√£o foi poss√≠vel inicializar a aplica√ß√£o.</p>
          <p style="margin-bottom: 20px; color: #666;">Erro: ${error.message}</p>
          <button onclick="location.reload()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
            üîÑ Recarregar P√°gina
          </button>
        </div>
      `;
    }
  }

  /**
   * Obt√©m informa√ß√µes sobre o estado da aplica√ß√£o
   */
  getAppInfo() {
    return {
      initialized: this.isInitialized,
      version: '3.0.0',
      mode: 'Standalone',
      storage: 'localStorage',
      transactionsCount: this.transactions.length,
      features: [
        'CRUD completo',
        'localStorage persistente',
        'Interface responsiva',
        'Atalhos de teclado',
        'Exportar/Importar dados',
        'Sem depend√™ncia de servidor'
      ]
    };
  }
}

// Inicializa a aplica√ß√£o
const app = new FinanceApp();
app.init();

// Exporta para uso global
window.app = app;

// Log de inicializa√ß√£o
console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë     üí∞ FINAN√áAS PESSOAIS V3.0       ‚ïë
‚ïë                                      ‚ïë
‚ïë  üèóÔ∏è  Modo Standalone                 ‚ïë
‚ïë  üíæ localStorage Only                ‚ïë
‚ïë  üé® Interface Responsiva             ‚ïë
‚ïë  üîß Sem Depend√™ncia de Servidor      ‚ïë
‚ïë                                      ‚ïë
‚ïë  Desenvolvido com ‚ù§Ô∏è em JavaScript   ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
`); 